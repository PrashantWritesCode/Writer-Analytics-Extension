{
  "version": 3,
  "sources": ["../src/background.ts"],
  "sourcesContent": ["/**\n * Background entry point\n *\n * - Story Analytics (WA_*) is handled here directly\n * - Chapter Analytics (CHAPTER_*) is handled ONLY by chapter orchestrator\n * - background.ts must NOT intercept CHAPTER_* messages\n */\n\nimport { appendChapterStat } from \"./chapter-analytics/storage/chapterStorage\";\n\n// helpers\nfunction loadAll(): Promise<Record<string, any>> {\n  return new Promise((resolve) =>\n    chrome.storage.local.get(null, (r) => resolve(r))\n  );\n}\n\nasync function saveStats(stats: StoryStats) {\n  const sid = stats.storyId || `unknown-${Date.now()}`;\n  const key = `writerAnalyticsStats-${sid}`;\n  return new Promise<void>((resolve) => {\n    chrome.storage.local.set({ [key]: stats }, () => {\n      resolve();\n    });\n  });\n}\n\n// onInstalled: try injecting into existing wattpad tabs (best-effort)\nchrome.runtime.onInstalled.addListener(async () => {\n  try {\n    const tabs = await chrome.tabs.query({ url: \"*://www.wattpad.com/*\" });\n    for (const t of tabs) {\n      if (t.id) {\n        try {\n          await chrome.scripting.executeScript({\n            target: { tabId: t.id },\n            files: [\"content.js\"],\n          });\n        } catch {\n          /* ignore */\n        }\n      }\n    }\n  } catch (err) {\n    console.warn(\"[background] onInstalled error\", err);\n  }\n});\n\nchrome.runtime.onMessage.addListener((message, sender, sendResponse) => {\n  (async () => {\n    try {\n      if (!message || !message.type) {\n        sendResponse({ success: false, error: \"invalid\" });\n        return;\n      }\n\n      // console.log(\"[background] UPDATE_CHAPTER_STATS received:\", message);\n      // -------------------------------\n      // Story Analytics (UNCHANGED)\n      // -------------------------------\n\n      if (message.type === \"GET_ACTIVE_STORY_ID\") {\n        chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {\n          const tab = tabs?.[0];\n          const storyId = tab?.url?.match(/\\/story\\/(\\d+)/i)?.[1] ?? null;\n          sendResponse({ storyId });\n        });\n        return;\n      }\n\n      if (message.type === \"WA_STATS\") {\n        const stats = message.payload as StoryStats;\n        if (stats) await saveStats(stats);\n        chrome.runtime.sendMessage(\n          { type: \"WA_UPDATE\", payload: stats },\n          () => {}\n        );\n        sendResponse({ success: true });\n        return;\n      }\n\n      if (message.type === \"GET_WA_STATS\") {\n        const all = await loadAll();\n        const keys = Object.keys(all).filter((k) =>\n          k.startsWith(\"writerAnalyticsStats-\")\n        );\n        if (!keys.length) {\n          sendResponse({ success: true, stats: null });\n          return;\n        }\n\n        let chosen: StoryStats | null = null;\n        for (const k of keys) {\n          const s = all[k] as StoryStats;\n          if (!chosen) chosen = s;\n          else if (\n            s?.capturedAt &&\n            chosen?.capturedAt &&\n            new Date(s.capturedAt).getTime() >\n              new Date(chosen.capturedAt).getTime()\n          ) {\n            chosen = s;\n          }\n        }\n\n        sendResponse({ success: true, stats: chosen });\n        return;\n      }\n\n      if (message.type === \"WA_REFRESH\") {\n        chrome.tabs.query(\n          { active: true, currentWindow: true },\n          async (tabs) => {\n            const tab = tabs?.[0];\n\n            // \uD83D\uDEA8 CRITICAL GUARD\n            if (\n              !tab?.id ||\n              !tab.url ||\n              tab.url.startsWith(\"chrome://\") ||\n              tab.url.startsWith(\"edge://\") ||\n              tab.url.startsWith(\"about:\")\n            ) {\n              const all = await loadAll();\n              const keys = Object.keys(all).filter((k) =>\n                k.startsWith(\"writerAnalyticsStats-\")\n              );\n              sendResponse({\n                success: true,\n                payload: keys.length ? all[keys[keys.length - 1]] : null,\n              });\n              return;\n            }\n\n            chrome.tabs.sendMessage(\n              tab.id,\n              { type: \"WA_REFRESH\" },\n              async (resp) => {\n                if (resp?.payload) {\n                  await saveStats(resp.payload as StoryStats);\n                  sendResponse({ success: true, payload: resp.payload });\n                } else {\n                  const all = await loadAll();\n                  const keys = Object.keys(all).filter((k) =>\n                    k.startsWith(\"writerAnalyticsStats-\")\n                  );\n                  sendResponse({\n                    success: true,\n                    payload: keys.length ? all[keys[keys.length - 1]] : null,\n                  });\n                }\n              }\n            );\n          }\n        );\n        return;\n      }\n\n      /* --- CHAPTER ANALYTICS UPDATE LOOP --- */\n      if (message.type === \"UPDATE_CHAPTER_STATS\") {\n        const { storyId } = message;\n\n        (async () => {\n          try {\n            const snapshotKey = `chapterAnalytics.snapshots.${storyId}`;\n            const data = await chrome.storage.local.get(snapshotKey);\n            const snapshot = data?.[snapshotKey];\n\n            if (!snapshot?.chapters) return;\n\n            for (const chapter of snapshot.chapters) {\n              if (!chapter.chapterUrl) continue;\n\n              let tab = await chrome.tabs.create({\n                url: chapter.chapterUrl,\n                active: false,\n              });\n\n              // 1. Wait for tab to be fully loaded\n              await new Promise<void>((resolve) => {\n                const listener = (id: number, info: any) => {\n                  if (id === tab.id && info.status === \"complete\") {\n                    chrome.tabs.onUpdated.removeListener(listener);\n                    resolve();\n                  }\n                };\n                chrome.tabs.onUpdated.addListener(listener);\n              });\n\n              // 2. Inject content script\n              await chrome.scripting.executeScript({\n                target: { tabId: tab.id! },\n                files: [\"content.js\"],\n              });\n\n              // 3. THE HANDSHAKE: Await the response from the content script\n              // This ensures the content script finishes waitForChapterStats() and storage.set()\n              try {\n                await chrome.tabs.sendMessage(tab.id!, {\n                  type: \"SCRAPE_CHAPTER_STATS\",\n                  storyId: storyId,\n                  chapterId: chapter.chapterId,\n                });\n                console.log(`\u2705 Chapter ${chapter.chapterId} processed.`);\n              } catch (msgErr) {\n                console.warn(\n                  `\u26A0\uFE0F Failed to get response from chapter ${chapter.chapterId}:`,\n                  msgErr\n                );\n              }\n\n              // 4. Small buffer to allow Chrome to settle its storage sync\n              await new Promise((r) => setTimeout(r, 500));\n\n              // 5. Safe to remove tab now\n              await chrome.tabs.remove(tab.id!).catch(() => {});\n            }\n\n            // \uD83C\uDFC1 Aggregation: Map the temporary keys into the main snapshot history\n            await finalizeChapterHistoryMapping(storyId);\n\n            console.log(\"\uD83C\uDFC1 All chapters scraped and history updated.\");\n          } catch (err) {\n            console.error(\"Decoupled Loop Error:\", err);\n          }\n        })();\n\n        sendResponse({ success: true, status: \"Processing\" });\n        return true;\n      }\n\n      sendResponse({ success: false, error: \"unknown type\" });\n    } catch (err) {\n      console.error(\"[background] handler err\", err);\n      sendResponse({\n        success: false,\n        error: (err as any)?.message || \"error\",\n      });\n    }\n  })();\n\n  return true;\n});\n\n// background.ts\nasync function finalizeChapterHistoryMapping(storyId: string) {\n  const snapshotKey = `chapterAnalytics.snapshots.${storyId}`;\n  const allData = await chrome.storage.local.get(null);\n  const snapshot = allData[snapshotKey];\n\n  if (!snapshot || !snapshot.chapters) return;\n\n  const keysToRemove: string[] = [];\n\n  snapshot.chapters = snapshot.chapters.map((chapter: any) => {\n    // This MUST match the key created in content.ts\n    const lookupKey = `temp_chapter_stats_${storyId}_${chapter.chapterId}`;\n    const freshStats = allData[lookupKey];\n\n    if (freshStats) {\n      if (!chapter.statHistory) chapter.statHistory = [];\n\n      // PUSH the data into the history array\n      chapter.statHistory.push({\n        reads: freshStats.reads,\n        votes: freshStats.votes,\n        comments: freshStats.comments,\n        createdAt: freshStats.capturedAt, // Matches your screenshot key 'createdAt'\n      });\n\n      // Update current values for the UI\n      chapter.reads = freshStats.reads;\n      chapter.votes = freshStats.votes;\n      chapter.comments = freshStats.comments;\n\n      keysToRemove.push(lookupKey);\n    }\n    return chapter;\n  });\n\n  // Save the updated master snapshot back to DB\n  await chrome.storage.local.set({ [snapshotKey]: snapshot });\n\n  // Clean up the temporary keys\n  await chrome.storage.local.remove(keysToRemove);\n\n  console.log(`\u2705 Mapping complete. StatHistory updated for ${storyId}`);\n}\n"],
  "mappings": "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",
  "names": []
}
