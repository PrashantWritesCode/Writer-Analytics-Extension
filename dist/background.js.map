{
  "version": 3,
  "sources": ["../src/background.ts"],
  "sourcesContent": ["\n\nconsole.log(\"[background] starting\");\n\n// helpers\nfunction loadAll(): Promise<Record<string, any>> {\n  return new Promise((resolve) => chrome.storage.local.get(null, (r) => resolve(r)));\n}\n\nasync function saveStats(stats: StoryStats) {\n  const sid = stats.storyId || `unknown-${Date.now()}`;\n  const key = `writerAnalyticsStats-${sid}`;\n  return new Promise<void>((resolve) => {\n    chrome.storage.local.set({ [key]: stats }, () => {\n      console.log(\"[background] saved\", key);\n      resolve();\n    });\n  });\n}\n\n// onInstalled: try injecting into existing wattpad tabs (best-effort)\nchrome.runtime.onInstalled.addListener(async () => {\n  try {\n    const tabs = await chrome.tabs.query({ url: \"*://www.wattpad.com/*\" });\n    for (const t of tabs) {\n      if (t.id && t.url && t.url.includes(\"/\")) {\n        try {\n          await chrome.scripting.executeScript({ target: { tabId: t.id }, files: [\"content.js\"] });\n        } catch (e) { /* ignore */ }\n      }\n    }\n  } catch (err) { console.warn(\"[background] onInstalled error\", err); }\n});\n\nchrome.runtime.onMessage.addListener((message, sender, sendResponse) => {\n  (async () => {\n    try {\n      if (!message || !message.type) { sendResponse({ success: false, error: \"invalid\" }); return; }\n\n      if (message.type === \"WA_STATS\") {\n        const stats = message.payload as StoryStats;\n        if (stats) await saveStats(stats);\n        // broadcast update\n        chrome.runtime.sendMessage({ type: \"WA_UPDATE\", payload: stats }, () => {});\n        sendResponse({ success: true });\n        return;\n      }\n\n      if (message.type === \"GET_WA_STATS\") {\n        const all = await loadAll();\n        const keys = Object.keys(all).filter(k => k.startsWith(\"writerAnalyticsStats-\"));\n        if (keys.length === 0) { sendResponse({ success: true, stats: null }); return; }\n        // pick latest if possible\n        let chosen: StoryStats | null = null;\n        for (const k of keys) {\n          const s = all[k] as StoryStats;\n          if (!s) continue;\n          if (!chosen) { chosen = s; continue; }\n          if (s.capturedAt && chosen.capturedAt) {\n            if (new Date(s.capturedAt).getTime() > new Date(chosen.capturedAt).getTime()) chosen = s;\n          }\n        }\n        sendResponse({ success: true, stats: chosen });\n        return;\n      }\n\n      if (message.type === \"WA_REFRESH\") {\n        chrome.tabs.query({ active: true, currentWindow: true }, async (tabs) => {\n          if (!tabs || tabs.length === 0 || !tabs[0].id) {\n            // fallback to latest cached\n            const all = await loadAll();\n            const keys = Object.keys(all).filter(k => k.startsWith(\"writerAnalyticsStats-\"));\n            const stats = keys.length ? (all[keys[keys.length-1]] as StoryStats) : null;\n            sendResponse({ success: true, payload: stats });\n            return;\n          }\n          const tabId = tabs[0].id!;\n          chrome.tabs.sendMessage(tabId, { type: \"WA_REFRESH\" }, async (resp) => {\n            if (chrome.runtime.lastError) {\n              // try injecting then re-request\n              try {\n                await chrome.scripting.executeScript({ target: { tabId }, files: [\"content.js\"] });\n                chrome.tabs.sendMessage(tabId, { type: \"WA_REFRESH\" }, async (resp2) => {\n                  if (resp2 && resp2.payload) {\n                    await saveStats(resp2.payload as StoryStats);\n                    sendResponse({ success: true, payload: resp2.payload });\n                  } else {\n                    const all = await loadAll();\n                    const keys = Object.keys(all).filter(k => k.startsWith(\"writerAnalyticsStats-\"));\n                    const stats = keys.length ? (all[keys[keys.length-1]] as StoryStats) : null;\n                    sendResponse({ success: true, payload: stats });\n                  }\n                });\n              } catch (err) {\n                const all = await loadAll();\n                const keys = Object.keys(all).filter(k => k.startsWith(\"writerAnalyticsStats-\"));\n                const stats = keys.length ? (all[keys[keys.length-1]] as StoryStats) : null;\n                sendResponse({ success: true, payload: stats });\n              }\n              return;\n            }\n            if (resp && resp.payload) {\n              await saveStats(resp.payload as StoryStats);\n              sendResponse({ success: true, payload: resp.payload });\n            } else {\n              const all = await loadAll();\n              const keys = Object.keys(all).filter(k => k.startsWith(\"writerAnalyticsStats-\"));\n              const stats = keys.length ? (all[keys[keys.length-1]] as StoryStats) : null;\n              sendResponse({ success: true, payload: stats });\n            }\n          });\n        });\n        return;\n      }\n\n      // unknown\n      sendResponse({ success: false, error: \"unknown type\" });\n    } catch (err) {\n      console.error(\"[background] handler err\", err);\n      try { sendResponse({ success: false, error: (err as any).message || \"error\" }); } catch {}\n    }\n  })();\n\n  return true;\n});\n"],
  "mappings": "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",
  "names": []
}
