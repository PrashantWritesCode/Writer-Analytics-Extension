{
  "version": 3,
  "sources": ["../src/popup.ts"],
  "sourcesContent": ["\nfunction $<T extends HTMLElement = HTMLElement>(id: string): T | null {\n  return document.getElementById(id) as T | null;\n}\n\nfunction formatNumber(num: number | null | undefined): string {\n  if (num === null || num === undefined) return \"\u2014\";\n  if (num >= 1000000) return (num / 1000000).toFixed(1) + \"M\";\n  if (num >= 1000) return (num / 1000).toFixed(1) + \"K\";\n  return num.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, \",\");\n}\n\nfunction firstN(text: string | undefined | null, n = 120) {\n  if (!text) return \"\";\n  const s = text.trim().replace(/\\s+/g, \" \");\n  return s.length <= n ? s : s.slice(0, n).trim() + \"\u2026\";\n}\n\nfunction showStatus(text: string, visible = true) {\n  const s = $(\"status\");\n  if (!s) return;\n  s.innerHTML = text;\n  s.style.display = visible ? \"block\" : \"none\";\n}\n\nfunction displayData(stats: StoryStats) {\n  showStatus(\"\", false);\n\n  const titleEl = $(\"title\");\n  const authorEl = $(\"author\");\n  if (titleEl) titleEl.textContent = stats.title || \"Untitled Story\";\n  if (authorEl) authorEl.textContent = stats.author ? `by ${stats.author}` : \"by Unknown Author\";\n\n  const readsEl = $(\"reads\");\n  const votesEl = $(\"votes\");\n  const headerCommentsEl = $(\"headerComments\");\n  const paragraphsCountEl = $(\"paragraphsCount\");\n\n  if (readsEl) readsEl.textContent = formatNumber(stats.reads);\n  if (votesEl) votesEl.textContent = formatNumber(stats.votes);\n  if (headerCommentsEl) headerCommentsEl.textContent = formatNumber(stats.headerComments);\n  if (paragraphsCountEl) paragraphsCountEl.textContent = formatNumber(stats.commentItemsCount);\n\n  const engagementEl = $(\"engagementRate\");\n  const commentRatioEl = $(\"commentRatio\");\n  const engagementRate = stats.reads && stats.votes && stats.reads > 0 ? ((stats.votes! / stats.reads!) * 100).toFixed(2) + \"%\" : \"\u2014\";\n  const commentRatio = stats.reads && stats.headerComments && stats.reads > 0 ? ((stats.headerComments! / stats.reads!) * 100).toFixed(2) + \"%\" : \"\u2014\";\n  if (engagementEl) engagementEl.textContent = engagementRate;\n  if (commentRatioEl) commentRatioEl.textContent = commentRatio;\n\n  // Top hits\n  const topHitsList = $(\"topHitsList\");\n  if (topHitsList) {\n    topHitsList.innerHTML = \"\";\n    if (stats.paragraphComments && stats.paragraphComments.length > 0) {\n      const top = [...stats.paragraphComments].sort((a, b) => (b.count ?? 0) - (a.count ?? 0)).slice(0, 3);\n      top.forEach((p) => {\n        const li = document.createElement(\"li\");\n        const snippet = firstN(p.snippet || p.raw || \"\", 80);\n        const count = p.count ?? 0;\n        li.innerHTML = `<span>${snippet}</span><span class=\"comment-badge\">\uD83D\uDCAC ${count} comments</span>`;\n        topHitsList.appendChild(li);\n      });\n    } else {\n      topHitsList.innerHTML = `<li style=\"opacity:.7\">No paragraph-level comments found</li>`;\n    }\n  }\n\n  // Paragraphs\n  const paragraphsList = $(\"paragraphsList\");\n  if (paragraphsList) {\n    paragraphsList.innerHTML = \"\";\n    if (stats.paragraphComments && stats.paragraphComments.length > 0) {\n      stats.paragraphComments.forEach((p) => {\n        const div = document.createElement(\"div\");\n        div.className = \"para\";\n        const snippet = firstN(p.snippet || p.raw || \"\", 90);\n        const count = p.count ?? 0;\n        div.innerHTML = `<span>${snippet}</span><span class=\"comment-badge\">\uD83D\uDCAC ${count} comments</span>`;\n        if (count > 5) div.classList.add(\"highlight\");\n        paragraphsList.appendChild(div);\n      });\n    } else {\n      paragraphsList.innerHTML = `<div style=\"padding:8px;opacity:.7\">No paragraphs available</div>`;\n    }\n  }\n}\n\n// load latest cached stats (search keys writerAnalyticsStats-*)\nfunction loadCachedLatest(callback: (stats: StoryStats | null) => void) {\n  chrome.storage.local.get(null, (result) => {\n    const keys = Object.keys(result).filter(k => k.startsWith(\"writerAnalyticsStats-\"));\n    if (keys.length === 0) {\n      callback(null);\n      return;\n    }\n    // prefer latest by capturedAt if available\n    let chosen: StoryStats | null = null;\n    let chosenKey = keys[0];\n    keys.forEach(k => {\n      const s = result[k];\n      if (!s) return;\n      if (!chosen) {\n        chosen = s;\n        chosenKey = k;\n        return;\n      }\n      try {\n        const a = s.capturedAt ? new Date(s.capturedAt).getTime() : 0;\n        const b = chosen.capturedAt ? new Date(chosen.capturedAt).getTime() : 0;\n        if (a > b) {\n          chosen = s;\n          chosenKey = k;\n        }\n      } catch {\n        // fallback: pick last key\n        chosen = s;\n        chosenKey = k;\n      }\n    });\n    callback(chosen);\n  });\n}\n\nfunction loadData(forceRefresh = false) {\n  showStatus(\"\uD83D\uDD04 Loading analytics...\", true);\n\n  if (forceRefresh) {\n    chrome.runtime.sendMessage({ type: \"WA_REFRESH\" }, (response) => {\n      if (chrome.runtime.lastError) {\n        console.warn(\"Refresh request error:\", chrome.runtime.lastError.message);\n        // fallback to cached\n        loadCachedLatest((s) => {\n          if (s) displayData(s);\n          else showStatus(\"No data found (refresh failed).\", true);\n        });\n        return;\n      }\n\n      if (response && response.payload) {\n        displayData(response.payload);\n      } else {\n        loadCachedLatest((s) => {\n          if (s) displayData(s);\n          else showStatus(\"No data found after refresh.\", true);\n        });\n      }\n    });\n  } else {\n    loadCachedLatest((s) => {\n      if (s) displayData(s);\n      else showStatus(\"Visit a Wattpad story page and let the extension collect data.\", true);\n    });\n  }\n}\n\ndocument.addEventListener(\"DOMContentLoaded\", () => {\n  // initial load\n  setTimeout(() => loadData(false), 80);\n\n  // refresh button\n  $(\"refresh-btn\")?.addEventListener(\"click\", () => {\n    loadData(true);\n  });\n\n  // export\n  $(\"export-btn\")?.addEventListener(\"click\", () => {\n    chrome.storage.local.get(null, (result) => {\n      const blob = new Blob([JSON.stringify(result, null, 2)], { type: \"application/json\" });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = \"writer-analytics.json\";\n      a.click();\n      URL.revokeObjectURL(url);\n    });\n  });\n});\n"],
  "mappings": "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",
  "names": []
}
